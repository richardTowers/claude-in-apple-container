#!/usr/bin/env python3
"""Launch a claude-code devcontainer."""

import argparse
import os
import re
import subprocess
import sys
import textwrap


def sanitize_name(dir_name: str) -> str:
    """Lowercase, replace non-[a-z0-9-] with '-', collapse runs, strip edges."""
    name = dir_name.lower()
    name = re.sub(r"[^a-z0-9-]", "-", name)
    name = re.sub(r"-{2,}", "-", name)
    name = name.strip("-")
    return name


def get_existing_containers() -> set:
    """Return a set of all existing container names."""
    result = subprocess.run(
        ["container", "list", "--all"],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        return set()
    lines = result.stdout.splitlines()
    # Skip the header line
    return {line.split()[0] for line in lines[1:] if line.strip()}


def find_free_name(base_name: str, existing: set) -> str:
    """Return base_name, or base_name-2, -3, â€¦ until not in existing."""
    if base_name not in existing:
        return base_name
    suffix = 2
    while True:
        candidate = f"{base_name}-{suffix}"
        if candidate not in existing:
            return candidate
        suffix += 1


def generate_zsh_completion() -> str:
    """Return a zsh completion script."""
    return textwrap.dedent("""\
        #compdef claude-container
        _claude-container() {
            _arguments \\
                '--help[Show help message and exit]' \\
                '--devcontainer[Run detached (sleep infinity) instead of interactive zsh]' \\
                '--dry-run[Print the command that would be run instead of running it]' \\
                '--name[Override the container name]:name' \\
                '--memory[Container memory limit]:memory' \\
                '--image[Container image]:image' \\
                '--shell-completion[Print a zsh completion script and exit]'
        }
    """)


def main():
    parser = argparse.ArgumentParser(
        prog="claude-container",
        description="Launch a claude-code devcontainer.",
    )
    parser.add_argument(
        "--devcontainer",
        action="store_true",
        default=False,
        help="Run detached (sleep infinity) instead of interactive zsh",
    )
    parser.add_argument(
        "--name",
        default=None,
        help="Override the container name (default: auto-derived from cwd)",
    )
    parser.add_argument(
        "--memory",
        default="8g",
        help="Container memory limit (default: 8g)",
    )
    parser.add_argument(
        "--image",
        default="claude-code-devcontainer:latest",
        help="Container image (default: claude-code-devcontainer:latest)",
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        default=False,
        help="Print the command that would be run instead of running it",
    )
    parser.add_argument(
        "--shell-completion",
        action="store_true",
        default=False,
        help="Print a zsh completion script and exit",
    )
    args = parser.parse_args()

    if args.shell_completion:
        print(generate_zsh_completion())
        sys.exit(0)

    # Resolve container name
    if args.name:
        name = args.name
    else:
        dir_name = sanitize_name(os.path.basename(os.getcwd()))
        base_name = f"claude-code-{dir_name}"
        existing = get_existing_containers()
        name = find_free_name(base_name, existing)

    cwd = os.getcwd()
    cmd = [
        "container", "run",
        "--name", name,
        "--memory", args.memory,
        "--volume", f"{cwd}:/workspace",
        "--volume", f"{name}-bashhistory:/commandhistory",
        "--volume", f"{name}-config:/home/node/.claude",
    ]

    # If running inside Ghostty, set TERM to xterm-ghostty
    if os.environ.get("GHOSTTY_RESOURCES_DIR"):
        cmd += ["--env", "TERM=xterm-ghostty"]

    if args.devcontainer:
        cmd += ["--detach", "--rm", args.image, "sleep", "infinity"]
    else:
        cmd += ["-i", "-t", "--rm", args.image, "zsh"]

    if args.dry_run:
        import shlex
        print(shlex.join(cmd))
    else:
        os.execvp("container", cmd)


if __name__ == "__main__":
    main()
